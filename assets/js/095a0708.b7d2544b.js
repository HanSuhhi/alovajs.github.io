"use strict";(self.webpackChunkalova_website=self.webpackChunkalova_website||[]).push([[7326],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>h});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),p=c(n),h=r,m=p["".concat(l,".").concat(h)]||p[h]||u[h]||o;return n?a.createElement(m,s(s({ref:t},d),{},{components:n})):a.createElement(m,s({ref:t},d))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,s=new Array(o);s[0]=p;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:r,s[1]=i;for(var c=2;c<o;c++)s[c]=n[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},4806:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>c});var a=n(7462),r=(n(7294),n(3905));const o={title:"Middleware",sidebar_position:40},s=void 0,i={unversionedId:"advanced/middleware",id:"advanced/middleware",title:"Middleware",description:"Request middleware is an asynchronous function. Although it is only a function, it provides a powerful ability to control almost all behaviors of a request. If you just use alova, then you probably don't need to use request middleware, because it is mainly used to complete custom request strategies, no matter simple or complex request strategies, you may use it, let's look at it next What magical powers does it have.",source:"@site/docs/08-advanced/04-middleware.md",sourceDirName:"08-advanced",slug:"/advanced/middleware",permalink:"/advanced/middleware",draft:!1,editUrl:"https://github.com/alovajs/alovajs.github.io/blob/main/docs/08-advanced/04-middleware.md",tags:[],version:"current",sidebarPosition:40,frontMatter:{title:"Middleware",sidebar_position:40},sidebar:"tutorialSidebar",previous:{title:"Custom Storage Adapter",permalink:"/advanced/custom-storage-adapter"},next:{title:"Custom States Hook",permalink:"/advanced/custom-stateshook"}},l={},c=[{value:"Middleware function",id:"middleware-function",level:2},{value:"Control response data",id:"control-response-data",level:2},{value:"change request",id:"change-request",level:2},{value:"Control errors",id:"control-errors",level:2},{value:"Catch errors",id:"catch-errors",level:3},{value:"Throw an error",id:"throw-an-error",level:3},{value:"Control response delay",id:"control-response-delay",level:2},{value:"more than that",id:"more-than-that",level:2},{value:"Included request information",id:"included-request-information",level:2},{value:"Control state",id:"control-state",level:2},{value:"Decorate the event",id:"decorate-the-event",level:2}],d={toc:c};function u(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Request middleware is an asynchronous function. Although it is only a function, it provides a powerful ability to control almost all behaviors of a request. If you just use alova, then you probably don't need to use request middleware, because it is mainly used to complete custom request strategies, no matter simple or complex request strategies, you may use it, let's look at it next What magical powers does it have."),(0,r.kt)("h2",{id:"middleware-function"},"Middleware function"),(0,r.kt)("p",null,"You can use request middleware in ",(0,r.kt)("inlineCode",{parentName:"p"},"useRequest"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"useWatcher"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"useFetcher"),". The following is a simple request middleware, which prints some information before and after the request without changing any request behavior."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"useRequest(todoList, {\n  async middleware(_, next) {\n    console.log('before request');\n    await next();\n    console.log('after request');\n  }\n});\n")),(0,r.kt)("p",null,"Here are a few things you need to know about the ",(0,r.kt)("inlineCode",{parentName:"p"},"next")," function call. This function is also an asynchronous function. Calling it can continue to send requests. At this time, the ",(0,r.kt)("em",{parentName:"p"},"loading")," state will be set to true, and then the request will be sent. The return value of next is a Promise instance with the response data, you can manipulate the return value in the middleware function."),(0,r.kt)("h2",{id:"control-response-data"},"Control response data"),(0,r.kt)("p",null,"The return value of the middleware function will be used as the response data of this request to participate in subsequent processing. If the middleware does not return any data but calls ",(0,r.kt)("inlineCode",{parentName:"p"},"next"),", the response data of this request will be used for subsequent processing."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"// The modified result will be used as the response data\nuseRequest(todoList, {\n  async middleware(_, next) {\n    const result = await next();\n    result.code = 500;\n    return result;\n  }\n});\n\n// Will participate in subsequent processing with the response data of this request\nuseRequest(todoList, {\n  async middleware(_, next) {\n    await next();\n  }\n});\n\n// will respond with the string abc\nuseRequest(todoList, {\n  async middleware(_, next) {\n    await next();\n    return 'abc';\n  }\n});\n")),(0,r.kt)("p",null,"There is also a special case here. When ",(0,r.kt)("inlineCode",{parentName:"p"},"next")," is not called and there is no return value, subsequent processing will not be performed, which means that ",(0,r.kt)("em",{parentName:"p"},"onSuccess"),", ",(0,r.kt)("em",{parentName:"p"},"onError"),", ",(0,r.kt)("em",{parentName:"p"},"onComplete")," response events will not be triggered."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"useRequest(todoList, {\n  async middleware() {}\n});\n")),(0,r.kt)("h2",{id:"change-request"},"change request"),(0,r.kt)("p",null,"Sometimes you want to change the request. At this time, you can specify another method instance in ",(0,r.kt)("inlineCode",{parentName:"p"},"next"),", and the information in this method will be requested when sending the request. At the same time, you can also set whether to force the request through ",(0,r.kt)("inlineCode",{parentName:"p"},"next")," Penetrating the cache is also very simple."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"useRequest(todoList, {\n  async middleware(_, next) {\n    await next({\n      // Change the requested method instance\n      method: newMethodInstance,\n\n      // Whether to force the request this time\n      force: true\n    });\n  }\n});\n")),(0,r.kt)("h2",{id:"control-errors"},"Control errors"),(0,r.kt)("h3",{id:"catch-errors"},"Catch errors"),(0,r.kt)("p",null,"In the middleware, you can capture the request error generated in ",(0,r.kt)("inlineCode",{parentName:"p"},"next"),", after capturing, the global ",(0,r.kt)("inlineCode",{parentName:"p"},"onError")," hook will no longer be triggered."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"useRequest(todoList, {\n  async middleware(_, next) {\n    try {\n      await next();\n    } catch (e) {\n      console.error('Error caught', e);\n    }\n  }\n});\n")),(0,r.kt)("h3",{id:"throw-an-error"},"Throw an error"),(0,r.kt)("p",null,"Of course, you can also throw a custom error in the middleware, even if the request is normal, the global ",(0,r.kt)("inlineCode",{parentName:"p"},"onError")," hook will be triggered."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"// When an error is thrown before the request, the request will not be sent\nuseRequest(todoList, {\n  async middleware(_, next) {\n    throw new Error('error on before request');\n    await next();\n  }\n});\n\n// When an error is thrown after the request, the request will be sent\nuseRequest(todoList, {\n  async middleware(_, next) {\n    await next();\n    throw new Error('error on after request');\n  }\n});\n")),(0,r.kt)("h2",{id:"control-response-delay"},"Control response delay"),(0,r.kt)("p",null,"In the middleware, we can delay the response or respond in advance. In the case of advance, although the response data cannot be obtained, some other data can be returned as the response data to participate in subsequent processing."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"// Delay response for 1 second\nuseRequest(todoList, {\n  async middleware(_, next) {\n    await new Promise(resolve => {\n      setTimeout(resolve, 1000);\n    });\n    return next();\n  }\n});\n\n// Respond immediately and use the string abc as the response data\nuseRequest(todoList, {\n  async middleware(_, next) {\n    return 'abc';\n  }\n});\n")),(0,r.kt)("h2",{id:"more-than-that"},"more than that"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"So far, all we have mentioned is the use of the second parameter ",(0,r.kt)("inlineCode",{parentName:"strong"},"next")," of the middleware, so what is the first parameter for? ")),(0,r.kt)("p",null,"The first parameter of the middleware contains some information about this request, as well as the control functions for the status and events returned in useHook such as ",(0,r.kt)("inlineCode",{parentName:"p"},"loading"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"data")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"onSuccess"),". Let's move on!"),(0,r.kt)("h2",{id:"included-request-information"},"Included request information"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"useRequest(todoList, {\n  async middleware(context, next) {\n    // The method instance of this request\n    context.method;\n\n    // The parameter array sent by the send function, the default is []\n    context.sendArgs;\n\n    // The cache data hit by this request\n    context.cachedResponse;\n\n    // configuration collection of useHook\n    context.config;\n\n    // The various states returned by useHook, including the following attributes\n    // loading, data, error, downloading, uploading, and additional states managed by managedStates\n    context.frontStates;\n    //...\n  }\n});\n")),(0,r.kt)("p",null,"Next, let's take a look at what controls are available."),(0,r.kt)("h2",{id:"control-state"},"Control state"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"context.update")," can be used to change the state in ",(0,r.kt)("inlineCode",{parentName:"p"},"context.frontStates"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"useRequest(todoList, {\n  async middleware(context, next) {\n    context.update({\n      // Modify the loading status to true in advance\n      loading: true,\n\n      // Modify the data value, such as setting custom initialization data\n      data: {\n        /* ... */\n      }\n    });\n\n    //...\n  }\n});\n")),(0,r.kt)("h2",{id:"decorate-the-event"},"Decorate the event"),(0,r.kt)("p",null,"You can also decorate ",(0,r.kt)("em",{parentName:"p"},"onSuccess"),", ",(0,r.kt)("em",{parentName:"p"},"onError"),", ",(0,r.kt)("em",{parentName:"p"},"onComplete")," callback functions in middleware to make them richer, such as changing the parameters of the callback function, or receiving the return value of the callback function to achieve more functions."),(0,r.kt)("p",null,"You can use ",(0,r.kt)("inlineCode",{parentName:"p"},"decorateSuccess"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"decorateError"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"decorateComplete")," functions to decorate callback functions. The following takes the success callback as an example, which is decorated in 3 places:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Added ",(0,r.kt)("inlineCode",{parentName:"li"},"custom")," attribute to event object;"),(0,r.kt)("li",{parentName:"ol"},"Added a second parameter to the success callback function, the value is ",(0,r.kt)("inlineCode",{parentName:"li"},"extra data"),";"),(0,r.kt)("li",{parentName:"ol"},"Receive the value of the second success callback function and print it;")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"const { onSuccess } = useRequest(todoList, {\n  //...\n  async middleware(context, next) {\n    // Decorate the successful callback function, the following function parameters are explained:\n    // handler: bound callback function\n    // event: the event object corresponding to the callback function\n    // index: The subscript of the callback function, indicating which callback function is currently being executed\n    // length: the number of callback functions bound\n    context.decorateSuccess((handler, event, index, length) => {\n      event.custom = 1;\n      const received = handler(event, 'extra data');\n      if (index === 1) {\n        console.log(`received the return value of ${index + 1} callback function:`, received);\n        // [Print information] Received the return value of the second callback function: I'm second handler\n      }\n    });\n    //...\n  }\n});\nonSuccess((event, extra) => {\n  console.log(event.custom); // 1\n  console.log(extra); // extra data\n});\nonSuccess((event, extra) => {\n  return \"I'm second handler\";\n});\n")),(0,r.kt)("p",null,"The usage of ",(0,r.kt)("inlineCode",{parentName:"p"},"decorateError"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"decorateComplete")," is the same as ",(0,r.kt)("inlineCode",{parentName:"p"},"decorateSuccess"),"."))}u.isMDXComponent=!0}}]);